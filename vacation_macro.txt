Option Explicit

Public Const MAX_EMPLOYEES As Integer = 20
Public Const BLOCK_COLS As Integer = 4
Public Const MAX_PERIODS As Integer = 10

Private Const COLOR_MONTH_1 As Long = &HF8F8F8
Private Const COLOR_MONTH_2 As Long = &HFFFFFF
Private Const DAYS_IN_MONTHS As String = "31,29,31,30,31,30,31,31,30,31,30,31"
Private Const VACATION_COLOR As Long = &HC6EFCE

Sub ОбновитьГрафик()
    Dim wsEmployees As Worksheet
    Dim wsSchedule As Worksheet
    Dim wsService As Worksheet
    
    Dim employeeCount As Long
    Dim vacationCount As Long
    Dim i As Long, j As Long
    Dim empBlockStart As Long
    
    Dim startDate As Date
    Dim endDate As Date
    Dim currentDate As Date
    Dim dateCol As Long
    
    Dim scheduleRow As Long
    Dim nameCell As Range
    Dim startDateCell As Range
    Dim endDateCell As Range
    
    Dim dateDict As Object
    Dim lastCol As Long
    Dim dictKey As String
    
    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual
    Application.EnableEvents = False
    
    On Error GoTo ErrorHandler
    
    employeeCount = 0
    vacationCount = 0
    
    Set wsEmployees = ThisWorkbook.Worksheets("СОТРУДНИКИ")
    Set wsSchedule = ThisWorkbook.Worksheets("ГРАФИК")
    Set wsService = ThisWorkbook.Worksheets("ДАТЫ")
    
    Call ОчиститьГрафик(wsSchedule)
    
    ' БЫСТРЫЙ ПОИСК ДАТ: создаем словарь для мгновенного доступа
    Set dateDict = CreateObject("Scripting.Dictionary")
    lastCol = wsService.Cells(1, wsService.Columns.Count).End(xlToLeft).Column
    
    For i = 3 To lastCol
        If Not IsEmpty(wsService.Cells(1, i).Value) Then
            If IsDate(wsService.Cells(1, i).Value) Then
                dateDict(Format(wsService.Cells(1, i).Value, "YYYYMMDD")) = i
            End If
        End If
    Next i
    
    ' ОСНОВНАЯ ОПТИМИЗАЦИЯ: остановка при пустых ФИО
    Dim stopProcessing As Boolean
    stopProcessing = False
    
    For i = 0 To MAX_EMPLOYEES - 1
        If stopProcessing Then Exit For
        
        empBlockStart = i * BLOCK_COLS + 1
        Set nameCell = wsEmployees.Cells(3, empBlockStart)
        
        ' Пропускаем пустые ФИО
        If Trim(nameCell.Value) = "" Then
            ' Если три подряд пустых ФИО, останавливаем обработку
            If i > 2 Then
                Dim emptyCount As Long
                emptyCount = 0
                For j = i To Application.Min(i + 2, MAX_EMPLOYEES - 1)
                    Dim testBlock As Long
                    testBlock = j * BLOCK_COLS + 1
                    If Trim(wsEmployees.Cells(3, testBlock).Value) = "" Then
                        emptyCount = emptyCount + 1
                    Else
                        Exit For
                    End If
                Next j
                
                If emptyCount >= 3 Then
                    stopProcessing = True
                End If
            End If
            GoTo NextEmployee
        End If
        
        employeeCount = employeeCount + 1
        scheduleRow = employeeCount + 4
        
        wsSchedule.Cells(scheduleRow, 1).Value = employeeCount
        wsSchedule.Cells(scheduleRow, 2).Value = nameCell.Value
        
        Call ВосстановитьЦветаМесяцев(wsSchedule, scheduleRow)
        
        ' Обработка периодов отпуска
        For j = 0 To MAX_PERIODS - 1
            Dim periodRow As Long
            periodRow = 4 + j
            
            Set startDateCell = wsEmployees.Cells(periodRow, empBlockStart + 2)
            Set endDateCell = wsEmployees.Cells(periodRow, empBlockStart + 3)
            
            If Not IsEmpty(startDateCell.Value) And Not IsEmpty(endDateCell.Value) Then
                If IsDate(startDateCell.Value) And IsDate(endDateCell.Value) Then
                    startDate = CDate(startDateCell.Value)
                    endDate = CDate(endDateCell.Value)
                    
                    If endDate >= startDate Then
                        vacationCount = vacationCount + 1
                        
                        currentDate = startDate
                        Do While currentDate <= endDate
                            ' БЫСТРЫЙ ПОИСК через словарь
                            dictKey = Format(currentDate, "YYYYMMDD")
                            If dateDict.Exists(dictKey) Then
                                dateCol = dateDict(dictKey)
                                
                                With wsSchedule.Cells(scheduleRow, dateCol)
                                    .Value = "О"
                                    .Interior.Color = VACATION_COLOR
                                    .Font.Bold = True
                                    .Font.Name = "Arial"
                                    .Font.Size = 9
                                    .HorizontalAlignment = xlCenter
                                    .VerticalAlignment = xlCenter
                                End With
                            End If
                            
                            currentDate = currentDate + 1
                        Loop
                    End If
                End If
            End If
        Next j

NextEmployee:
    Next i
    
    wsSchedule.Columns("B:B").AutoFit
    
    Application.ScreenUpdating = True
    Application.Calculation = xlCalculationAutomatic
    Application.EnableEvents = True
    
    MsgBox "График отпусков обновлен за " & Format(Timer, "0.0") & " сек!" & vbCrLf & _
           "Сотрудников: " & employeeCount & vbCrLf & _
           "Периодов отпуска: " & vacationCount, _
           vbInformation, "График обновлен"
    
    wsSchedule.Activate
    wsSchedule.Range("A1").Select
    
    Exit Sub

ErrorHandler:
    Application.ScreenUpdating = True
    Application.Calculation = xlCalculationAutomatic
    Application.EnableEvents = True
    
    MsgBox "Ошибка: " & Err.Description, vbCritical, "Ошибка"
End Sub

Private Sub ОчиститьГрафик(wsSchedule As Worksheet)
    Dim lastRow As Long
    Dim lastCol As Long
    Dim i As Long, j As Long
    
    lastRow = wsSchedule.Cells(wsSchedule.Rows.Count, "B").End(xlUp).Row
    
    If lastRow >= 5 Then
        wsSchedule.Range("A5:B" & lastRow).ClearContents
        
        lastCol = wsSchedule.Cells(3, wsSchedule.Columns.Count).End(xlToLeft).Column
        
        If lastCol >= 3 Then
            For i = 5 To lastRow
                For j = 3 To lastCol
                    With wsSchedule.Cells(i, j)
                        .Value = ""
                        .Font.Bold = False
                        .Interior.Pattern = xlNone
                    End With
                Next j
                Call ВосстановитьЦветаМесяцев(wsSchedule, i)
            Next i
        End If
    End If
End Sub

Private Sub ВосстановитьЦветаМесяцев(wsSchedule As Worksheet, rowNum As Long)
    Dim monthDays() As String
    Dim i As Long, j As Long
    Dim col As Long
    Dim monthColor As Long
    Dim daysInMonth As Integer
    
    monthDays = Split(DAYS_IN_MONTHS, ",")
    col = 3
    
    For i = 0 To UBound(monthDays)
        daysInMonth = CInt(monthDays(i))
        
        If (i Mod 2) = 0 Then
            monthColor = COLOR_MONTH_1
        Else
            monthColor = COLOR_MONTH_2
        End If
        
        For j = 1 To daysInMonth
            wsSchedule.Cells(rowNum, col).Interior.Color = monthColor
            col = col + 1
        Next j
    Next i
End Sub

Sub ТестовыеДанные()
    Dim ws As Worksheet
    Dim i As Long
    Dim blockStart As Long
    
    Set ws = ThisWorkbook.Worksheets("СОТРУДНИКИ")
    
    For i = 0 To MAX_EMPLOYEES - 1
        blockStart = i * BLOCK_COLS + 1
        ws.Cells(3, blockStart).ClearContents
        ws.Range(ws.Cells(4, blockStart + 2), ws.Cells(13, blockStart + 3)).ClearContents
    Next i
    
    ws.Cells(3, 1).Value = "Иванов И.И."
    ws.Cells(4, 3).Value = DateSerial(2026, 1, 10)
    ws.Cells(4, 4).Value = DateSerial(2026, 1, 20)
    ws.Cells(6, 3).Value = DateSerial(2026, 6, 10)
    ws.Cells(6, 4).Value = DateSerial(2026, 6, 15)
    
    ws.Cells(3, 5).Value = "Петров П.П."
    ws.Cells(4, 7).Value = DateSerial(2026, 5, 1)
    ws.Cells(4, 8).Value = DateSerial(2026, 5, 15)
    
    ws.Cells(3, 9).Value = "Сидоров С.С."
    ws.Cells(4, 11).Value = DateSerial(2026, 8, 1)
    ws.Cells(4, 12).Value = DateSerial(2026, 8, 14)
    
    For i = 0 To MAX_EMPLOYEES - 1
        blockStart = i * BLOCK_COLS + 1
        ws.Range(ws.Cells(4, blockStart + 2), ws.Cells(13, blockStart + 3)).NumberFormat = "DD.MM.YYYY"
    Next i
    
    ws.Calculate
    
    MsgBox "Тестовые данные добавлены", vbInformation, "Готово"
End Sub
